# テスト駆動開発（TDD）のプロジェクト指針

このプロジェクトは、t_wada氏の思想に基づいたテスト駆動開発を実践します。

## 基本原則

### 1. テストファースト
- **プロダクションコードより先にテストを書く**
- テストを書くことで、実装すべき仕様を明確にする
- テストがない機能は実装しない

### 2. Red-Green-Refactor サイクル
1. **Red**: 失敗するテストを書く（まだ実装がないため失敗する）
2. **Green**: テストを通す最小限のコードを書く（仮実装でもOK）
3. **Refactor**: 重複を排除し、コードをきれいにする

### 3. 小さなステップで進める
- 一度に1つのテストケースに集中する
- 大きな機能は小さなタスクに分割する
- 各ステップで必ずテストをパスさせる

## コード品質の考え方

### 動作するきれいなコード
> "Make it work, make it right, make it fast" - Kent Beck

1. まず動かす（テストを通す）
2. 次にきれいにする（リファクタリング）
3. 必要なら速くする（パフォーマンス改善）

### 質とスピードはトレードオフではない
- テストがあることで、安心してリファクタリングできる
- 早く動くコードより、早く変更できるコードを目指す
- 技術的負債は利子がつく前に返済する

## テストの書き方

### テストは仕様でありドキュメントである
- テストケース名は、何をテストしているか明確に記述する
- 日本語でのテストケース名も積極的に使う
- Given-When-Then（Arrange-Act-Assert）パターンを意識する

```typescript
// Good: 何をテストしているか明確
test("ユーザー検索で名前に'田中'を含む場合、該当するユーザーのみ返す", () => {
  // Given: 複数のユーザーが存在する状態
  // When: '田中'で検索する
  // Then: 田中さんのみが返される
});

// Bad: 何をテストしているか不明確
test("search works", () => {
  // ...
});
```

### テストの3A原則
- **Arrange（準備）**: テストに必要なデータやモックを準備
- **Act（実行）**: テスト対象の関数やメソッドを実行
- **Assert（検証）**: 期待する結果と実際の結果を比較

### テスタビリティを意識した設計
- 依存性の注入（DI）を活用する
- 純粋関数を優先する（副作用を最小化）
- 外部依存（API、DB）はモック可能な設計にする
- グローバル状態への依存を避ける

## 実装の進め方

### 仮実装から本実装へ
1. **仮実装**: ハードコードで最速でテストを通す
2. **三角測量**: 複数のテストケースを追加して、一般化の必要性を確認
3. **明白な実装**: 仮実装を本実装にリファクタリング

### TODOリストの活用
- 実装前に必要なテストケースをTODOリストに書き出す
- 1つずつテストを実装し、完了したらチェックを入れる
- 新たな気づきがあれば、TODOリストに追加する

例:
```
[ ] 検索クエリが空の場合、全ユーザーを返す
[ ] 名前に検索クエリが含まれるユーザーを返す
[ ] メールアドレスに検索クエリが含まれるユーザーを返す
[ ] 該当するユーザーがいない場合、空配列を返す
[ ] 検索は大文字小文字を区別しない
```

## リファクタリングの原則

### テストがあるからリファクタリングできる
- テストが通っている状態でのみリファクタリングする
- リファクタリング中はテストを追加しない
- リファクタリング後は必ずすべてのテストを実行する

### コードの重複を排除する
- DRY原則（Don't Repeat Yourself）を守る
- 同じロジックが2箇所に現れたら、3箇所目が出る前にリファクタリングする
- ただし、過度な抽象化は避ける（YAGNI: You Aren't Gonna Need It）

## CI/CDとの統合

### テストは常に実行される
- コミット前にテストを実行する
- CI環境でテストを自動実行する
- テストが失敗したらマージしない

### テストカバレッジ
- カバレッジは品質の指標の1つに過ぎない
- 100%を目指すのではなく、重要なロジックを確実にテストする
- テストの「質」がカバレッジよりも重要

## このプロジェクト固有の規約

### React Router v7でのテスト
- loader関数は必ずテストを書く（サーバーサイドロジック）
- コンポーネントは統合テストを優先する
- useLoaderDataのモックは最小限にする

### 推奨するテストツール
- **Vitest**: 高速で型安全なテストランナー
- **React Testing Library**: ユーザー視点でのコンポーネントテスト
- **MSW (Mock Service Worker)**: API通信のモック

### テストファイルの配置
```
app/
  routes/
    home.tsx
    home.test.tsx  # テストは実装の隣に配置
```

## 参考資料
- 『テスト駆動開発』Kent Beck著
- 『リファクタリング』Martin Fowler著
- t_wada氏のブログ・講演資料

## 心構え
> "テストは未来の自分へのラブレター"

テストを書くことで：
- 仕様が明確になる
- リグレッションを防げる
- 安心してリファクタリングできる
- ドキュメントとして機能する
- 設計が改善される

**テストは「コスト」ではなく「投資」である**
